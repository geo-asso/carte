<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Ajouter un Point d'Int√©r√™t</title>

    <!-- Leaflet CSS pour la minimap (sans integrity/crossorigin pour √©viter blocage si le hash ne correspond pas) -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 40px 20px;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            padding: 40px;
        }
        h1 { color: #2c3e50; margin-bottom: 10px; text-align: center; }
        .subtitle { text-align: center; color: #7f8c8d; margin-bottom: 30px; }
        .form-group { margin-bottom: 25px; }
        label { display: block; color: #2c3e50; font-weight: 600; margin-bottom: 8px; }
        label .required { color: #e74c3c; }
        input, select, textarea {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 15px;
            font-family: inherit;
            transition: border-color 0.3s;
        }
        input:focus, select:focus, textarea:focus { outline: none; border-color: #667eea; }
        textarea { resize: vertical; min-height: 100px; }
        .help-text { font-size: 13px; color: #7f8c8d; margin-top: 5px; }
        .button-group { display: flex; gap: 15px; margin-top: 30px; }
        button {
            flex: 1;
            padding: 14px 24px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }
        .btn-submit { background: #27ae60; color: white; }
        .btn-submit:hover { background: #229954; transform: translateY(-2px); box-shadow: 0 4px 12px rgba(39,174,96,0.4); }
        .btn-cancel { background: #95a5a6; color: white; }
        .btn-cancel:hover { background: #7f8c8d; }
        .info-box { background: #e8f4f8; border-left: 4px solid #3498db; padding: 15px; border-radius: 8px; margin-bottom: 25px; }
        .info-box h3 { color: #2c3e50; margin-bottom: 8px; font-size: 16px; }
        .info-box p { color: #555; font-size: 14px; line-height: 1.6; }
        .error-message {
            display: none;
            background: #f8d7da;
            border: 2px solid #dc3545;
            color: #721c24;
            padding: 14px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        .success-message {
            display: none;
            background: #e6ffed;
            border: 2px solid #27ae60;
            color: #155724;
            padding: 14px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        .back-link { display: inline-block; color: #667eea; text-decoration: none; margin-bottom: 20px; font-weight: 600; }
        .back-link:hover { text-decoration: underline; }
        .coordinate-helper {
            background: #f8f9fa; padding: 15px; border-radius: 8px; margin-top: 10px; font-size: 13px;
        }
        .coordinate-helper a { color: #667eea; text-decoration: none; font-weight: 600; }
        .coordinate-helper a:hover { text-decoration: underline; }

        /* Inline address + button */
        .address-row { display: flex; gap: 10px; align-items: flex-start; }
        .address-row input { flex: 1; }
        .inline-btn {
            padding: 10px 12px; border: none; border-radius: 8px; background: #667eea; color: white; font-weight: 600;
            cursor: pointer; white-space: nowrap; align-self: center; display: inline-flex; gap: 8px; align-items: center;
        }
        .inline-btn[disabled] { opacity: 0.65; cursor: not-allowed; transform: none; box-shadow: none; }
        .inline-btn:hover:not([disabled]) { background: #5665d4; transform: translateY(-2px); box-shadow: 0 4px 8px rgba(102,126,234,0.25); }

        /* Spinner (int√©gr√© dans le bouton) */
        .spinner {
            width: 16px; height: 16px; border: 2px solid rgba(255,255,255,0.4); border-top-color: #fff;
            border-radius: 50%; animation: spin 1s linear infinite; display: inline-block;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        .muted { color: #7f8c8d; font-size: 13px; }

        /* Minimaps style */
        #miniMap {
            width: 100%;
            height: 260px;
            border-radius: 8px;
            border: 1px solid #e0e0e0;
            margin-top: 12px;
            display: none; /* cach√©e tant qu'il n'y a pas de coordonn√©es */
            overflow: hidden;
        }
        .map-controls { margin-top: 8px; display: flex; gap: 10px; align-items: center; }
        .map-hint { font-size: 13px; color: #7f8c8d; }

        /* petit style pour lien de reset coords */
        .reset-coords {
            background: #95a5a6; color: white; padding: 8px 10px; border-radius: 8px; border: none; cursor: pointer;
        }
        .reset-coords:hover { background: #7f8c8d; }

        /* horaires multi */
        .horaire-list { display: flex; flex-direction: column; gap: 10px; margin-top: 8px; }
        .horaire-entry {
            border: 1px solid #e0e0e0;
            padding: 10px;
            border-radius: 8px;
            background: #fbfdff;
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }
        .days-checkboxes { display: flex; gap: 6px; flex-wrap: wrap; align-items: center; }
        .days-checkboxes label { font-weight: 500; font-size: 13px; color: #34495e; }
        .horaire-entry .times { display: flex; gap: 8px; align-items: center; }
        .horaire-entry .remove-horaire { background: #e74c3c; color: white; padding: 8px 10px; border-radius: 8px; border: none; cursor: pointer; }
        .horaire-entry .remove-horaire:hover { background: #c0392b; }
        .add-horaire-btn { background: #667eea; color: white; padding: 10px 12px; border-radius: 8px; border: none; cursor: pointer; }
        .add-horaire-btn:hover { background: #5665d4; }
        .small { font-size: 13px; color: #7f8c8d; }
    </style>
</head>
<body>
    <div class="container">
        <a href="index.html" class="back-link">‚Üê Retour √† la carte</a>

        <h1>üìß Ajouter un Point d'Int√©r√™t</h1>
        <p class="subtitle">Envoyez votre proposition par email</p>

        <div class="info-box">
            <h3>üìã Processus de contribution</h3>
            <p>En cliquant sur "Envoyer par email", votre client email s'ouvrira avec un message pr√©-rempli. V√©rifiez les informations et cliquez sur Envoyer dans votre client email.</p>
        </div>

        <div id="errorMessage" class="error-message" role="alert" aria-live="polite"></div>
        <div id="successMessage" class="success-message" role="status" aria-live="polite"></div>

        <form id="poiForm">
            <div class="form-group">
                <label for="nom">Nom du lieu <span class="required">*</span></label>
                <input type="text" id="nom" name="nom" required placeholder="Ex: Mon repair caf√©" />
            </div>

            <div class="form-group">
                <label for="categorie">Cat√©gorie <span class="required">*</span></label>
                <select id="categorie" name="categorie" required>
                    <option value="">-- Choisir une cat√©gorie --</option>
                    <option value="repair caf√©">repair caf√©</option>
                    <option value="ressourcerie">ressourcerie</option>
                </select>
            </div>

            <div class="form-group">
                <label for="coordonnees">Coordonn√©es GPS <span class="required">*</span></label>
                <input type="text" id="coordonnees" name="coordonnees" required placeholder="Ex: 48.359944, 2.824667" />
                <p class="help-text">Format: latitude, longitude (s√©par√©s par une virgule)</p>
                <div class="coordinate-helper">
                    üí° <strong>Comment trouver les coordonn√©es ?</strong><br />
                    1. Allez sur <a href="https://www.google.com/maps" target="_blank" rel="noopener">Google Maps</a><br />
                    2. Faites un clic droit sur le lieu<br />
                    3. Cliquez sur les coordonn√©es en haut pour les copier<br />
                    4. Collez directement dans le champ ci-dessus (format: 48.359944, 2.824667)
                </div>
            </div>

            <div class="form-group">
                <label for="adresse">Adresse compl√®te <span class="required">*</span></label>
                <div class="address-row">
                    <input type="text" id="adresse" name="adresse" required placeholder="Ex: 15 Rue de la Paix, 77000 Melun" />
                    <button type="button" id="geolocateBtn" class="inline-btn" title="Obtenir les coordonn√©es depuis l'adresse" aria-live="polite">
                        <span id="geolocateIcon">üîé</span>
                        <span id="geolocateText">G√©olocaliser</span>
                    </button>
                </div>
                <p class="muted">Cliquez sur "G√©olocaliser" pour remplir automatiquement les coordonn√©es GPS √† partir de l'adresse (utilise OpenStreetMap).</p>

                <!-- Minimaps + contr√¥les -->
                <div id="miniMap" aria-label="Mini carte de v√©rification des coordonn√©es"></div>
                <div class="map-controls" id="mapControls" style="display:none;">
                    <div class="map-hint">V√©rifiez la position sur la carte. Cliquez sur la carte pour repositionner le marqueur.</div>
                    <button type="button" id="resetMapBtn" class="reset-coords" title="Vider les coordonn√©es">Effacer coordonn√©es</button>
                </div>
            </div>

            <div class="form-group">
                <label for="description">Description <span class="required">*</span></label>
                <textarea id="description" name="description" required placeholder="D√©crivez ce lieu en quelques mots..."></textarea>
            </div>

            <div class="form-group">
                <label for="telephone">T√©l√©phone</label>
                <input type="tel" id="telephone" name="telephone" placeholder="Ex: 01 42 00 00 00" />
            </div>

            <div class="form-group">
                <label for="email">E-mail</label>
                <input type="tel" id="email" name="email" placeholder="geo-asso@protonmail.com" />
            </div>

            <!-- Horaires multiple -->
            <div class="form-group">
                <label>Horaires (optionnel)</label>
                <div id="horairesMulti">
                    <div class="small">Ajoutez un ou plusieurs cr√©neaux d'ouverture. Exemple: Lundi √† Vendredi 09:00 - 18:00</div>
                    <div id="horairesList" class="horaire-list" aria-live="polite">
                        <!-- entries added dynamically -->
                    </div>
                    <div style="margin-top:10px;">
                        <button type="button" id="addHoraireBtn" class="add-horaire-btn">+ Ajouter un cr√©neau</button>
                    </div>

                    <div style="margin-top:12px;">
                        <div class="small">Ou laissez un texte libre (sera utilis√© si aucun cr√©neau structur√© n'est ajout√©):</div>
                        <input type="text" id="horaires_libre" name="horaires_libre" placeholder="Ex: Lun-Ven 9h-18h / Sam 9h-12h" />
                    </div>
                </div>
            </div>

            <div class="form-group">
                <label for="site_web">Site web</label>
                <input type="url" id="site_web" name="site_web" placeholder="https://exemple.com" />
            </div>

            <div class="form-group">
                <label for="contributeur_nom">Votre nom (optionnel)</label>
                <input type="text" id="contributeur_nom" name="contributeur_nom" placeholder="Pour signature" />
            </div>

            <div class="button-group">
                <button type="button" class="btn-cancel" onclick="window.location.href='index.html'">Annuler</button>
                <button type="submit" class="btn-submit">üìß Envoyer par email</button>
            </div>
        </form>

        <div class="info-box" style="margin-top: 30px;">
            <h3>‚ÑπÔ∏è Comment √ßa fonctionne ?</h3>
            <p>Le formulaire ouvrira votre client email (Gmail, Outlook, Thunderbird, etc.) avec toutes les informations pr√©-remplies. Vous devrez simplement cliquer sur "Envoyer" dans votre applicat[...]
        </div>
    </div>

    <!-- Leaflet JS pour la minimap (sans integrity/crossorigin) -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script>
        // Elements
        const geolocateBtn = document.getElementById('geolocateBtn');
        const geolocateIcon = document.getElementById('geolocateIcon');
        const geolocateText = document.getElementById('geolocateText');
        const adresseInput = document.getElementById('adresse');
        const coordInput = document.getElementById('coordonnees');
        const errorDiv = document.getElementById('errorMessage');
        const successDiv = document.getElementById('successMessage');
        const miniMapEl = document.getElementById('miniMap');
        const mapControls = document.getElementById('mapControls');
        const resetMapBtn = document.getElementById('resetMapBtn');

        // Horaires √©l√©ments
        const addHoraireBtn = document.getElementById('addHoraireBtn');
        const horairesList = document.getElementById('horairesList');
        const horairesLibreInput = document.getElementById('horaires_libre');

        // Leaflet map state
        let map = null;
        let marker = null;
        let isMapInitialized = false;

        function showError(message) {
            successDiv.style.display = 'none';
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
        }

        function showSuccess(message) {
            errorDiv.style.display = 'none';
            successDiv.textContent = message;
            successDiv.style.display = 'block';
            setTimeout(() => {
                successDiv.style.display = 'none';
            }, 5000);
        }

        function setButtonLoading(loading) {
            if (loading) {
                geolocateBtn.disabled = true;
                geolocateIcon.innerHTML = ''; // remove icon
                // insert spinner
                geolocateIcon.innerHTML = '<span class="spinner" aria-hidden="true"></span>';
                geolocateText.textContent = ' Recherche...';
            } else {
                geolocateBtn.disabled = false;
                geolocateIcon.innerHTML = 'üîé';
                geolocateText.textContent = 'G√©olocaliser';
            }
        }

        async function geocodeAddress(address) {
            if (!address || address.trim().length < 5) {
                showError('‚ö†Ô∏è Entrez une adresse valide avant de g√©olocaliser.');
                return null;
            }

            setButtonLoading(true);
            errorDiv.style.display = 'none';

            try {
                const params = new URLSearchParams({
                    q: address,
                    format: 'json',
                    limit: '1',
                    addressdetails: '0',
                    'accept-language': 'fr'
                });
                const url = `https://nominatim.openstreetmap.org/search?${params.toString()}`;

                const response = await fetch(url, {
                    method: 'GET',
                    headers: { 'Accept': 'application/json' }
                });

                if (!response.ok) throw new Error('Erreur r√©seau lors de la g√©olocalisation.');

                const results = await response.json();
                if (!results || results.length === 0) {
                    showError('‚ö†Ô∏è Aucune coordonn√©e trouv√©e pour cette adresse. Essayez d\'√™tre plus pr√©cis.');
                    return null;
                }

                const top = results[0];
                const lat = parseFloat(top.lat);
                const lon = parseFloat(top.lon);

                if (isNaN(lat) || isNaN(lon)) {
                    showError('‚ö†Ô∏è R√©sultat de g√©olocalisation invalide.');
                    return null;
                }

                // Mettre √† jour le champ coordonn√©es
                coordInput.value = `${lat.toFixed(6)}, ${lon.toFixed(6)}`;
                showSuccess('‚úÖ Coordonn√©es mises √† jour depuis l\'adresse.');

                updateMap(lat, lon, true);
                return { lat, lon };
            } catch (err) {
                console.error(err);
                showError('‚ö†Ô∏è Impossible de g√©olocaliser l\'adresse pour le moment. V√©rifiez votre connexion ou r√©essayez plus tard.');
                return null;
            } finally {
                setButtonLoading(false);
            }
        }

        // Initialise la minimap (la premi√®re fois qu'on en a besoin)
        function initMap() {
            // si Leaflet n'est pas charg√©, afficher un message utilisateur clair et abandonner
            if (typeof L === 'undefined') {
                showError('‚ö†Ô∏è La biblioth√®que de carte (Leaflet) n\'a pas pu √™tre charg√©e. V√©rifiez votre connexion ou retirez les attributs "integrity"/"crossorigin" si pr√©sents.');
                return;
            }

            if (isMapInitialized) return;
            // afficher la div
            miniMapEl.style.display = 'block';
            mapControls.style.display = 'flex';

            // init leaflet
            map = L.map('miniMap', { attributionControl: false }).setView([46.8, 2.4], 6); // France centr√© par d√©faut

            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                maxZoom: 19,
                attribution: '&copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a> contributors'
            }).addTo(map);

            // click to set marker and update coords
            map.on('click', function(e) {
                const { lat, lng } = e.latlng;
                setMarker(lat, lng, true);
                coordInput.value = `${lat.toFixed(6)}, ${lng.toFixed(6)}`;
                showSuccess('‚úÖ Coordonn√©es mises √† jour depuis la carte.');
            });

            isMapInitialized = true;
        }

        function setMarker(lat, lon, pan = true) {
            initMap();
            if (typeof L === 'undefined') return; // s√©curit√© suppl√©mentaire

            if (!marker) {
                marker = L.marker([lat, lon], { draggable: true }).addTo(map);
                // when marker is dragged, update coords input
                marker.on('dragend', function(e) {
                    const pos = marker.getLatLng();
                    coordInput.value = `${pos.lat.toFixed(6)}, ${pos.lng.toFixed(6)}`;
                    showSuccess('‚úÖ Coordonn√©es mises √† jour depuis le marqueur.');
                });
            } else {
                marker.setLatLng([lat, lon]);
            }
            if (pan) map.setView([lat, lon], 16);
            // ensure map renders properly if it was hidden initially
            setTimeout(() => { map.invalidateSize(); }, 200);
        }

        function updateMap(lat, lon, showIfHidden = false) {
            if (lat === undefined || lon === undefined) return;
            if (!isMapInitialized && showIfHidden) initMap();
            if (!isMapInitialized) initMap();
            if (typeof L === 'undefined') return;
            setMarker(lat, lon, true);
        }

        // bouton geolocate
        geolocateBtn.addEventListener('click', function () {
            errorDiv.style.display = 'none';
            successDiv.style.display = 'none';
            const address = adresseInput.value.trim();
            geocodeAddress(address);
        });

        // Si l'utilisateur √©dite manuellement les coordonn√©es -> mettre √† jour la carte
        coordInput.addEventListener('blur', function() {
            const v = coordInput.value.trim();
            if (!v) {
                // si champ vide, cacher la carte
                miniMapEl.style.display = 'none';
                mapControls.style.display = 'none';
                return;
            }
            const parts = v.split(',').map(s => s.trim());
            if (parts.length !== 2) {
                showError('‚ö†Ô∏è Format de coordonn√©es invalide. Utilisez: latitude, longitude.');
                return;
            }
            const lat = parseFloat(parts[0]);
            const lon = parseFloat(parts[1]);
            if (isNaN(lat) || isNaN(lon) || lat < -90 || lat > 90 || lon < -180 || lon > 180) {
                showError('‚ö†Ô∏è Coordonn√©es invalides. La latitude doit √™tre entre -90 et 90, la longitude entre -180 et 180.');
                return;
            }
            // ok -> update map and clear errors
            errorDiv.style.display = 'none';
            updateMap(lat, lon, true);
            showSuccess('‚úÖ Coordonn√©es affich√©es sur la carte.');
        });

        // Effacer coords
        resetMapBtn.addEventListener('click', function() {
            coordInput.value = '';
            if (marker && map) {
                map.removeLayer(marker);
                marker = null;
            }
            miniMapEl.style.display = 'none';
            mapControls.style.display = 'none';
            showSuccess('Coordonn√©es effac√©es.');
        });

        // Auto g√©olocaliser au blur de l'adresse si coords vides (comportement optionnel)
        adresseInput.addEventListener('blur', function() {
            const address = adresseInput.value.trim();
            if (address.length > 5 && !coordInput.value.trim()) {
                // l√©g√®re temporisation pour ne pas g√™ner la saisie
                setTimeout(() => {
                    if (!coordInput.value.trim()) geocodeAddress(address);
                }, 400);
            }
        });

        // ---------------------------
        // Horaires multi - functions
        // ---------------------------
        const WEEK_DAYS = ['Lundi','Mardi','Mercredi','Jeudi','Vendredi','Samedi','Dimanche'];

        function createHoraireEntry() {
            const entry = document.createElement('div');
            entry.className = 'horaire-entry';

            // days checkboxes
            const daysWrap = document.createElement('div');
            daysWrap.className = 'days-checkboxes';
            WEEK_DAYS.forEach((d, idx) => {
                const id = `day_${Date.now()}_${idx}_${Math.floor(Math.random()*1000)}`;
                const label = document.createElement('label');
                label.style.display = 'flex';
                label.style.alignItems = 'center';
                label.style.gap = '4px';
                const cb = document.createElement('input');
                cb.type = 'checkbox';
                cb.value = d;
                cb.id = id;
                cb.name = 'jours';
                cb.style.width = '14px';
                cb.style.height = '14px';
                const span = document.createElement('span');
                span.textContent = d.slice(0,3); // affichage court (Lun, Mar...)
                label.appendChild(cb);
                label.appendChild(span);
                daysWrap.appendChild(label);
            });

            // times
            const timesWrap = document.createElement('div');
            timesWrap.className = 'times';
            const fromInput = document.createElement('input');
            fromInput.type = 'time';
            fromInput.className = 'horaire-from';
            fromInput.title = 'Heure d\'ouverture';
            fromInput.placeholder = '09:00';
            fromInput.style.width = '120px';

            const toInput = document.createElement('input');
            toInput.type = 'time';
            toInput.className = 'horaire-to';
            toInput.title = 'Heure de fermeture';
            toInput.placeholder = '18:00';
            toInput.style.width = '120px';

            timesWrap.appendChild(fromInput);
            const separator = document.createElement('span');
            separator.textContent = '‚Üí';
            separator.style.margin = '0 4px';
            timesWrap.appendChild(separator);
            timesWrap.appendChild(toInput);

            // remove button
            const removeBtn = document.createElement('button');
            removeBtn.type = 'button';
            removeBtn.className = 'remove-horaire';
            removeBtn.textContent = 'Supprimer';
            removeBtn.addEventListener('click', function() {
                horairesList.removeChild(entry);
            });

            entry.appendChild(daysWrap);
            entry.appendChild(timesWrap);
            entry.appendChild(removeBtn);
            return entry;
        }

        addHoraireBtn.addEventListener('click', function() {
            const e = createHoraireEntry();
            horairesList.appendChild(e);
        });

        // ---------------------------
        // Form submit (existant) - ajust√© pour horaires multiples
        // ---------------------------
        document.getElementById('poiForm').addEventListener('submit', function(e) {
            e.preventDefault();
            errorDiv.style.display = 'none';

            // R√©cup√©rer et parser les coordonn√©es
            const coordonneesInput = document.getElementById('coordonnees').value.trim();
            const coordsParts = coordonneesInput.split(',').map(c => c.trim());

            if (coordsParts.length !== 2) {
                const errorDivLocal = document.getElementById('errorMessage');
                errorDivLocal.textContent = '‚ö†Ô∏è Format de coordonn√©es invalide. Utilisez le format: latitude, longitude (ex: 48.359944, 2.824667)';
                errorDivLocal.style.display = 'block';
                return;
            }

            const lat = parseFloat(coordsParts[0]);
            const lng = parseFloat(coordsParts[1]);

            if (isNaN(lat) || isNaN(lng) || lat < -90 || lat > 90 || lng < -180 || lng > 180) {
                const errorDivLocal = document.getElementById('errorMessage');
                errorDivLocal.textContent = '‚ö†Ô∏è Coordonn√©es invalides. La latitude doit √™tre entre -90 et 90, la longitude entre -180 et 180.';
                errorDivLocal.style.display = 'block';
                return;
            }

            // Collecter horaires structur√©s
            const horaireEntries = [];
            const entryNodes = horairesList.querySelectorAll('.horaire-entry');
            entryNodes.forEach(node => {
                const checkedDays = Array.from(node.querySelectorAll('input[type="checkbox"][name="jours"]:checked')).map(cb => cb.value);
                const from = node.querySelector('.horaire-from').value;
                const to = node.querySelector('.horaire-to').value;

                // validation basique : au moins un jour et horaires valides
                if (checkedDays.length === 0) {
                    // skip empty entries (user might have added then not filled)
                    return;
                }
                if (!from || !to) {
                    // skip invalid
                    return;
                }
                // ensure from <= to (simple string compare should work for hh:mm)
                if (from > to) {
                    // swap if user inverted
                    const tmp = from; from = to; to = tmp;
                }
                horaireEntries.push({
                    jours: checkedDays,
                    ouverture: from,
                    fermeture: to
                });
            });

            // Prepare formData
            const telephoneVal = document.getElementById('telephone').value;
            const horairesLibreVal = horairesLibreInput.value.trim();

            const formData = {
                nom: document.getElementById('nom').value,
                categorie: document.getElementById('categorie').value,
                lat: lat,
                lng: lng,
                adresse: document.getElementById('adresse').value,
                description: document.getElementById('description').value,
                telephone: telephoneVal || 'Non renseign√©',
                horaires_raw: horairesLibreVal || 'Non renseign√©', // fallback
                site_web: document.getElementById('site_web').value || 'Non renseign√©',
                contributeur: document.getElementById('contributeur_nom').value || 'Anonyme'
            };

            // Cr√©er le JSON pour l'email
            const pointJSON = {
                nom: formData.nom,
                categorie: formData.categorie,
                lat: formData.lat,
                lng: formData.lng,
                description: formData.description,
                adresse: formData.adresse
            };

            if (formData.telephone !== 'Non renseign√©') pointJSON.telephone = formData.telephone;
            if (formData.site_web !== 'Non renseign√©') pointJSON.site_web = formData.site_web;

            // Horaires : privil√©gier structure si pr√©sente, sinon texte libre, sinon absent
            if (horaireEntries.length > 0) {
                pointJSON.horaires = horaireEntries;
            } else if (formData.horaires_raw && formData.horaires_raw !== 'Non renseign√©') {
                pointJSON.horaires = formData.horaires_raw;
            }

            // Cr√©er le contenu de l'email
            const sujet = encodeURIComponent(`[Carte Interactive] Nouveau point d'int√©r√™t : ${formData.nom}`);

            const corpsObj = `Bonjour,

Je souhaite proposer l'ajout d'un nouveau point d'int√©r√™t sur la carte interactive.

=== INFORMATIONS DU POINT ===

Nom : ${formData.nom}
Cat√©gorie : ${formData.categorie}
Latitude : ${formData.lat}
Longitude : ${formData.lng}
Adresse : ${formData.adresse}
Description : ${formData.description}
T√©l√©phone : ${formData.telephone}
Horaires : ${horaireEntries.length > 0 ? '(format structur√© envoy√© en JSON)' : formData.horaires_raw}
Site web : ${formData.site_web}

=== DONN√âES JSON √Ä AJOUTER ===

${JSON.stringify(pointJSON, null, 2)}

=== LIEN GOOGLE MAPS ===

https://www.google.com/maps?q=${formData.lat},${formData.lng}

---
Propos√© par : ${formData.contributeur}

Cordialement`;

            const corps = encodeURIComponent(corpsObj);

            // Cr√©er le lien mailto
            const mailtoLink = `mailto:geo-asso@proton.me?subject=${sujet}&body=${corps}`;

            // Ouvrir le client email
            window.location.href = mailtoLink;
        });

        // Si la page s'ouvre avec des coordonn√©es d√©j√† pr√©sentes (pr√©-remplies), afficher la carte
        (function checkInitialCoords() {
            const v = coordInput.value.trim();
            if (!v) return;
            const parts = v.split(',').map(s => s.trim());
            if (parts.length !== 2) return;
            const lat = parseFloat(parts[0]);
            const lon = parseFloat(parts[1]);
            if (!isNaN(lat) && !isNaN(lon)) {
                updateMap(lat, lon, true);
            }
        })();
    </script>
</body>
</html>
