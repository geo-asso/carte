<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Ajouter un point d'int√©r√™t ‚Äî Formulaire</title>
  <style>
    body { font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif; background:#f6f8fa; margin:0; padding:20px; }
    .container { max-width:900px; margin:0 auto; background:#fff; padding:20px; border-radius:10px; box-shadow:0 6px 18px rgba(0,0,0,0.06); }
    h1 { text-align:center; color:#2c3e50; margin-bottom:10px; }
    form { display:grid; gap:12px; }
    label { font-weight:600; color:#34495e; }
    input[type="text"], input[type="email"], input[type="tel"], textarea, select {
      width:100%; padding:10px; border-radius:6px; border:1px solid #dfe6ee; outline:none;
    }
    textarea { min-height:100px; resize:vertical; }
    .row { display:flex; gap:12px; }
    .row > * { flex:1; }
    .btn { display:inline-block; padding:10px 14px; border-radius:8px; border:none; cursor:pointer; }
    .btn-primary { background:#27ae60; color:#fff; font-weight:700; }
    .btn-ghost { background:transparent; border:1px solid #d0d7df; color:#2c3e50; }
    .small { font-size:13px; color:#7f8c8d; }
    .horaires-list { background:#fbfcfd; padding:12px; border-radius:8px; border:1px dashed #e6eef6; }
    .horaires-row { display:flex; gap:8px; margin-bottom:8px; align-items:center; }
    .horaires-row input { flex:1; }
    .actions { display:flex; gap:8px; flex-wrap:wrap; margin-top:8px; }
    pre#json-preview { background:#0e1724; color:#e6f6ff; padding:12px; border-radius:8px; overflow:auto; max-height:300px; }
    .hint { font-size:13px; color:#586b7a; }
    .geo-btn { padding:8px 10px; border-radius:6px; border:none; background:#3498db; color:#fff; cursor:pointer; }
    .remove-btn { background:#e74c3c; color:#fff; padding:6px 10px; border-radius:6px; border:none; cursor:pointer; }
    .inline { display:inline-flex; gap:8px; align-items:center; }
    footer { margin-top:14px; font-size:13px; color:#7f8c8d; text-align:center; }
  </style>
</head>
<body>
  <div class="container">
    <h1>‚ûï Ajouter un point d'int√©r√™t</h1>

    <form id="poi-form">
      <div>
        <label for="nom">Nom</label>
        <input id="nom" name="nom" type="text" required placeholder="Nom du lieu (ex : Ressourcerie ABC)" />
      </div>

      <div>
        <label for="categorie">Cat√©gorie</label>
        <select id="categorie" name="categorie" required>
          <option value="ressourcerie">ressourcerie</option>
          <option value="repaircaf√©">repaircaf√©</option>
          <option value="autre">autre</option>
        </select>
      </div>

      <div>
        <label for="adresse">Adresse (libre)</label>
        <input id="adresse" name="adresse" type="text" placeholder="Adresse compl√®te" />
      </div>

      <div class="row">
        <div>
          <label for="lat">Latitude</label>
          <input id="lat" name="lat" type="text" placeholder="46.12345" />
        </div>
        <div>
          <label for="lng">Longitude</label>
          <input id="lng" name="lng" type="text" placeholder="1.23456" />
        </div>
      </div>

      <div class="inline">
        <button type="button" id="geocode-btn" class="geo-btn">üîé Trouver coordonn√©es (Nominatim)</button>
        <div class="hint">Saisissez une adresse puis cliquez sur "Trouver coordonn√©es" pour remplir lat/lng automatiquement.</div>
      </div>

      <div class="row">
        <div>
          <label for="telephone">T√©l√©phone</label>
          <input id="telephone" name="telephone" type="tel" placeholder="0123456789" />
        </div>
        <div>
          <label for="email">E‚Äëmail</label>
          <input id="email" name="email" type="email" placeholder="contact@example.org" />
        </div>
      </div>

      <div>
        <label for="site_web">Site web (optionnel)</label>
        <input id="site_web" name="site_web" type="text" placeholder="https://..." />
      </div>

      <div>
        <label for="description">Description</label>
        <textarea id="description" name="description" placeholder="Courte description du lieu"></textarea>
      </div>

      <div>
        <label>Horaires (format structur√© recommand√©)</label>
        <div class="horaires-list" id="horaires-list">
          <!-- lignes horaires ajout√©es dynamiquement ici -->
        </div>
        <div class="actions">
          <button type="button" id="add-horaire" class="btn btn-ghost">‚ûï Ajouter un horaire</button>
          <span class="small">Chaque horaire = { "jours": "Lundi - Vendredi", "heures": "09:00 - 12:00, 14:00 - 18:00" }</span>
        </div>
      </div>

      <div class="row">
        <div>
          <label for="raw-horaires">Horaires (ou coller un bloc texte)</label>
          <textarea id="raw-horaires" placeholder="Optionnel : coller un bloc texte avec sauts de ligne si vous pr√©f√©rez"></textarea>
          <div class="small">Si vous remplissez √† la fois les "horaires structur√©s" et le "bloc texte", le structur√© sera prioritaire.</div>
        </div>
      </div>

      <div class="actions">
        <button type="submit" class="btn btn-primary">G√©n√©rer JSON</button>
        <button type="button" id="clear-form" class="btn btn-ghost">R√©initialiser</button>
      </div>
    </form>

    <h2>Aper√ßu JSON</h2>
    <pre id="json-preview">{}</pre>

    <div class="actions" style="margin-top:10px;">
      <button id="copy-json" class="btn btn-ghost">Copier le JSON</button>
      <button id="download-json" class="btn btn-ghost">T√©l√©charger (.json)</button>
      <button id="add-to-storage" class="btn btn-ghost">Ajouter au stockage local</button>
    </div>

    <footer>
      Apr√®s g√©n√©ration : copiez/t√©l√©chargez le JSON puis ajoutez-le au fichier points-interet.json de ton d√©p√¥t (ou envoie-le √† ton API si tu en as une).
    </footer>
  </div>

  <script>
    // Utilitaires
    const $ = id => document.getElementById(id);

    // Initialisation des horaires avec une ligne par d√©faut
    const horairesList = $('horaires-list');

    function createHoraireRow(jours = '', heures = '') {
      const wrapper = document.createElement('div');
      wrapper.className = 'horaires-row';

      const inputJ = document.createElement('input');
      inputJ.type = 'text';
      inputJ.placeholder = 'Jours (ex: Lundi - Vendredi)';
      inputJ.value = jours;

      const inputH = document.createElement('input');
      inputH.type = 'text';
      inputH.placeholder = 'Heures (ex: 09:00 - 12:00, 14:00 - 18:00)';
      inputH.value = heures;

      const remove = document.createElement('button');
      remove.type = 'button';
      remove.className = 'remove-btn';
      remove.textContent = 'Suppr';
      remove.onclick = () => wrapper.remove();

      wrapper.appendChild(inputJ);
      wrapper.appendChild(inputH);
      wrapper.appendChild(remove);

      return wrapper;
    }

    function addHoraire(j = '', h = '') {
      horairesList.appendChild(createHoraireRow(j, h));
    }

    // Ajout initial
    addHoraire();

    $('add-horaire').addEventListener('click', e => {
      addHoraire();
    });

    // Geocoding simple via Nominatim (OpenStreetMap)
    $('geocode-btn').addEventListener('click', async () => {
      const adresse = $('adresse').value.trim();
      if (!adresse) { alert('Saisissez d\'abord une adresse.'); return; }
      const url = 'https://nominatim.openstreetmap.org/search?format=json&q=' + encodeURIComponent(adresse);
      try {
        $('geocode-btn').disabled = true;
        $('geocode-btn').textContent = 'Recherche‚Ä¶';
        const resp = await fetch(url, { headers: { 'Accept-Language': 'fr' }});
        const results = await resp.json();
        if (results && results.length) {
          const r = results[0];
          $('lat').value = r.lat;
          $('lng').value = r.lon;
          alert('Coordonn√©es trouv√©es et ins√©r√©es.');
        } else {
          alert('Aucun r√©sultat trouv√© pour cette adresse.');
        }
      } catch (err) {
        console.error(err);
        alert('Erreur lors du g√©ocodage.');
      } finally {
        $('geocode-btn').disabled = false;
        $('geocode-btn').textContent = 'üîé Trouver coordonn√©es (Nominatim)';
      }
    });

    // R√©cup√®re horaires structur√©s depuis l'UI
    function collectHorairesStructured() {
      const rows = Array.from(horairesList.children);
      const result = [];
      rows.forEach(r => {
        const inputs = r.querySelectorAll('input');
        if (!inputs || inputs.length < 2) return;
        const jours = inputs[0].value.trim();
        const heures = inputs[1].value.trim();
        if (jours || heures) {
          result.push({ jours, heures });
        }
      });
      return result;
    }

    // Validation simple lat/lng
    function isValidCoord(v) {
      if (v === null || v === undefined || String(v).trim() === '') return false;
      return !isNaN(Number(v));
    }

    function buildPOI() {
      const nom = $('nom').value.trim();
      const categorie = $('categorie').value;
      const adresse = $('adresse').value.trim();
      const lat = $('lat').value.trim();
      const lng = $('lng').value.trim();
      const telephone = $('telephone').value.trim();
      const email = $('email').value.trim();
      const description = $('description').value.trim();
      const site_web = $('site_web').value.trim();

      // Horaires : priorit√© au structur√© si non vide, sinon au bloc texte
      let horaires = collectHorairesStructured();
      if (horaires.length === 0) {
        const raw = $('raw-horaires').value.trim();
        if (raw) {
          // convertir en tableau de lignes
          const lines = raw.split(/\\r?\\n/).map(s => s.trim()).filter(Boolean);
          horaires = lines; // on laisse en cha√Æne/array de cha√Ænes pour index.html qui g√®re les deux
        } else {
          horaires = null;
        }
      }

      const obj = {
        nom: nom || '',
        adresse: adresse || '',
        lat: isValidCoord(lat) ? Number(lat) : null,
        lng: isValidCoord(lng) ? Number(lng) : null,
        categorie: categorie || 'autre',
        telephone: telephone || '',
        email: email || '',
        description: description || '',
        horaires: horaires,
        site_web: site_web || ''
      };

      return obj;
    }

    // Rendu du preview JSON
    function renderPreview(obj) {
      const pretty = JSON.stringify(obj, null, 2);
      $('json-preview').textContent = pretty;
    }

    // Soumission (g√©n√®re et affiche le JSON)
    $('poi-form').addEventListener('submit', e => {
      e.preventDefault();
      const poi = buildPOI();

      // simple validation - nom et coordonn√©es
      if (!poi.nom) { alert('Le nom est requis.'); return; }
      if (poi.lat === null || poi.lng === null) {
        if (!confirm('Les coordonn√©es lat/lng sont absentes ou invalides. Continuer quand m√™me ?')) {
          return;
        }
      }

      renderPreview(poi);
      alert('JSON g√©n√©r√© dans l\'aper√ßu. Copiez/t√©l√©chargez-le puis ajoutez-le au fichier points-interet.json.');
    });

    // Copier le JSON
    $('copy-json').addEventListener('click', async () => {
      const txt = $('json-preview').textContent;
      try {
        await navigator.clipboard.writeText(txt);
        alert('JSON copi√© dans le presse-papiers.');
      } catch (err) {
        alert('Impossible de copier automatiquement. S√©lectionnez manuellement le texte pour copier.');
      }
    });

    // T√©l√©charger le JSON
    $('download-json').addEventListener('click', () => {
      const txt = $('json-preview').textContent;
      const blob = new Blob([txt], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      const safeName = ($('nom').value || 'poi').replace(/[^a-z0-9-_]/gi, '_').toLowerCase();
      a.download = safeName + '.json';
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    });

    // Ajouter au localStorage (utile pour tests locaux)
    $('add-to-storage').addEventListener('click', () => {
      try {
        const raw = $('json-preview').textContent;
        const item = JSON.parse(raw || '{}');
        const existing = JSON.parse(localStorage.getItem('points_interet_local') || '[]');
        existing.push(item);
        localStorage.setItem('points_interet_local', JSON.stringify(existing, null, 2));
        alert('Point ajout√© au stockage local (localStorage). Pour tests uniquement.');
      } catch (err) {
        alert('Aucun JSON valide trouv√© dans l\'aper√ßu. G√©n√©rer d\'abord.');
      }
    });

    // Clear form
    $('clear-form').addEventListener('click', () => {
      if (!confirm('R√©initialiser le formulaire ?')) return;
      $('poi-form').reset();
      while (horairesList.firstChild) horairesList.removeChild(horairesList.firstChild);
      addHoraire();
      $('json-preview').textContent = '{}';
    });

    // Pr√©-remplir le preview vide
    renderPreview({});
  </script>
</body>
</html>
